---
services:
  vpn:
    image: qmcgaw/gluetun
    container_name: vpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=Canada
      - VPN_PORT_FORWARDING=on
      - GLUETUN_HTTP_CONTROL_SERVER_ENABLE=on
    volumes:
      - ${PLEX}/vpn:/vpn
    ports:
      - 6881:6881
      - 6881:6881/udp
      - 8080:8080
      - 8286:8286
    restart: unless-stopped
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:5.1.2
    container_name: qbittorrent
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
    volumes:
      - ${PLEX}/qbittorrent/config:/config
      - ${PLEX}/data/torrents:/data/torrents
    network_mode: service:vpn
    depends_on:
      - vpn
    restart: unless-stopped
  qsticky:
    image: ghcr.io/monstermuffin/qsticky:latest
    container_name: qsticky
    environment:
      - QBITTORRENT_HOST=vpn
      - QBITTORRENT_HTTPS=false
      - QBITTORRENT_PORT=8080
      - QBITTORRENT_USER=${QBITTORRENT_USER}
      - QBITTORRENT_PASS=${QBITTORRENT_PASS}
      - GLUETUN_HOST=vpn
      - GLUETUN_AUTH_TYPE=apikey
      - GLUETUN_APIKEY=${GLUETUN_APIKEY}
      - LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "python3", "-c", "import json; exit(0 if json.load(open('/app/health/status.json'))['healthy'] else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
    volumes:
      - ${PLEX}/config:/config
      - ${PLEX}/data/media:/data/media
    devices:
      - /dev/dri:/dev/dri
    restart: unless-stopped
  kometa:
    image: kometateam/kometa:nightly
    container_name: kometa
    environment:
      - TZ=${TZ}
      - KOMETA_RUN=false
      - KOMETA_TIMES=00:00,02:00,06:30,17:00,19:00,20:00
      - KOMETA_CONFIG=/config/config.yml
      - KOMETA_IPADDRESS=${IP_ADDRESS}
      - KOMETA_PLEXTOKEN=${PLEX_TOKEN}
      - KOMETA_TMDBKEY=${TMDB_API_KEY}
      - KOMETA_RADARRKEY=${RADARR_API_KEY}
    volumes:
      - ${PLEX}/kometa/config:/config
    restart: unless-stopped
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${PLEX}/radarr/data:/config
      - ${PLEX}/data:/data
    ports:
      - 7878:7878
    restart: unless-stopped
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${PLEX}/sonarr/data:/config
      - ${PLEX}/data:/data
    ports:
      - 8989:8989
    restart: unless-stopped
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${PLEX}/bazarr/data:/config
      - ${PLEX}/data:/data
    ports:
      - 6767:6767
    restart: unless-stopped
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${PLEX}/prowlarr/data:/config
    ports:
      - 9696:9696
    restart: unless-stopped
  overseerr:
    image: sctx/overseerr:latest
    container_name: overseerr
    environment:
      - TZ="America/Toronto"
    ports:
      - 5055:5055
    volumes:
      - ${PLEX}/overseerr/data:/app/config
    restart: unless-stopped
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - ${PLEX}/cloudflared:/etc/cloudflared
    restart: unless-stopped
  tautulli:
    image: ghcr.io/tautulli/tautulli
    container_name: tautulli
    volumes:
      - ${PLEX}/tautulli/data:/config
    ports:
      - 8181:8181
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    restart: unless-stopped
  ersatztv:
    image: jasongdove/ersatztv
    container_name: ersatztv
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - 8409:8409
    volumes:
      - ${PLEX}/ersatztv/data:/root/.local/share/ersatztv
      - ${PLEX}/data:/data:ro
    restart: unless-stopped
  ticketing:
    container_name: ticketing
    image: docker.io/alexbmoreira/plex-home-theatre:latest
    environment:
      - PLEX_TOKEN=${PLEX_TOKEN}
      - PLEX_URL=${PLEX_URL}
      - CLIENT_NAME=${CLIENT_NAME}
    ports:
      - 5067:5067
    restart: unless-stopped
  wizarr:
    container_name: wizarr
    image: ghcr.io/wizarrrr/wizarr:latest
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - 5690:5690
    volumes:
      - ${PLEX}/wizarr/database:/data/database
    restart: unless-stopped
  arcane:
    container_name: arcane
    image: ghcr.io/ofkm/arcane:latest
    ports:
      - 3552:3552
    volumes:
      - ${PLEX}/arcane/data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - APP_URL=http://localhost:3552
      - ENCRYPTION_KEY=${ARCANE_ENCRYPTION_KEY}
      - JWT_SECRET=${ARCANE_JWT_SECRET}
    restart: unless-stopped

  # eBooks

  booklore:
    image: booklore/booklore:latest
    container_name: booklore
    environment:
      - USER_ID=${BOOKLORE_USER_ID}
      - GROUP_ID=${BOOKLORE_GROUP_ID}
      - TZ=${TZ}
      - DATABASE_URL=${BOOKLORE_DATABASE_URL}
      - DATABASE_USERNAME=${BOOKLORE_DB_USER}
      - DATABASE_PASSWORD=${BOOKLORE_DB_PASSWORD}
      - BOOKLORE_PORT=${BOOKLORE_PORT}
    depends_on:
      bookloredb:
        condition: service_healthy
    volumes:
      - ${PLEX}/booklore/data:/app/data
      - ${PLEX}/booklore/bookdrop:/bookdrop
      - ${PLEX}/data:/data
    restart: unless-stopped
  nginx-booklore:
    image: nginx:alpine
    container_name: nginx-booklore
    environment:
      - BOOKLORE_PORT=${BOOKLORE_PORT}
    volumes:
      - ${PLEX}/nginx/booklore.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - 8083:80
    depends_on:
      - booklore
    restart: unless-stopped
  bookloredb:
    image: lscr.io/linuxserver/mariadb:11.4.5
    container_name: bookloredb
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - MYSQL_ROOT_PASSWORD=${BOOKLORE_MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${BOOKLORE_MYSQL_DATABASE}
      - MYSQL_USER=${BOOKLORE_DB_USER}
      - MYSQL_PASSWORD=${BOOKLORE_DB_PASSWORD}
    volumes:
      - ${PLEX}/bookloredb/config:/config
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mariadb-admin", "ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
  ephemera:
    image: ghcr.io/orwellianepilogue/ephemera:latest
    container_name: ephemera
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - AA_BASE_URL=${AA_BASE_URL}
      - AA_API_KEY=${AA_API_KEY}
      - FLARESOLVERR_URL=${FLARESOLVERR_URL}
    volumes:
      - ${PLEX}/ephemera/data:/app/data
      - ${PLEX}/ephemera/downloads:/app/downloads
      - ${PLEX}/booklore/bookdrop:/app/ingest
    network_mode: service:vpn
    depends_on:
      - vpn
    restart: unless-stopped
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - TZ=${TZ}
      - LOG_LEVEL=info
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
    restart: unless-stopped
